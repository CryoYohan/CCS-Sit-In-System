{% macro flash_message() -%}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%}
<div class="fixed top-4 left-4 space-y-4 z-50">
  {% for category, message in messages %}
  <div
    class="animate-fade-in transform transition-all duration-300 ease-in-out flex items-center justify-between p-4 rounded-lg shadow-lg text-white {% if category == 'success' %} bg-green-500 {% elif category == 'error' %} bg-red-500 {% else %} bg-blue-500 {% endif %}">
    <span>{{ message }}</span>
    <button onclick="this.parentElement.remove()" class="ml-4 p-1 rounded-full hover:bg-opacity-25 focus:outline-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
          clip-rule="evenodd" />
      </svg>
    </button>
  </div>
  {% endfor %}
</div>
{% endif %} {% endwith %} {%- endmacro %} {% macro navbar(user_in_login_page,
action,user, image) %} {% if not user_in_login_page %}
<nav class="flex justify-between items-center p-4 bg-black text-white shadow-sm">
  <!-- Title -->
  <div
    class="text-3xl font-bold text-transparent bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text">
    <a href="{{ url_for('main.index') }}">CCSit.</a>
  </div>
  <div class="flex space-x-8 text-l text-white pr-12">
    <a href="{{ url_for('main.login') }}" class="text-white text-l hover:text-blue-600 transition duration-3000">{{
      action }}</a>
  </div>
</nav>
{% elif user_in_login_page and action=='Logout' and user.role == 'Admin'%}
<nav class="flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-800 text-white shadow-sm">
  <div
    class="text-3xl font-bold text-transparent bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text">
    <a href="{{ url_for('admin.dashboard') }}">CCSit.</a>
  </div>
  <div class="relative flex items-center space-x-8 pr-12">
    <!-- Notification Button (existing) -->
    <div class="relative">
      <button id="notification-button-admin"
        class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white relative"
        aria-label="Notifications">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <span id="notification-badge"
          class="hidden absolute top-0 right-0 inline-block w-3 h-3 bg-red-500 border-2 border-white dark:border-gray-800 rounded-full"></span>
      </button>

      <!-- Notification Dropdown -->
      <div id="notification-dropdown-admin"
        class="hidden absolute right-0 mt-2 w-72 bg-white dark:bg-gray-700 rounded-lg shadow-lg z-50 divide-y divide-gray-100 dark:divide-gray-600">
        <div class="px-4 py-3 text-sm text-gray-900 dark:text-white">
          <p class="font-medium">Notifications</p>
        </div>
        <div class="py-1 max-h-96 overflow-y-auto">
          <!-- Empty State -->
          <div id="empty-notifications" class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400">
            No new notifications
          </div>
          <!-- Notification Items (dynamically populated) -->
          <div id="notification-items"></div>
        </div>
        <div class="py-1">
          <a href="#"
            class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 text-center">
            View all notifications
          </a>
        </div>
      </div>
    </div>
    <div class="relative">
      <button id="profile-menu-admin"
        class="flex items-center space-x-3 p-2 bg-white dark:bg-gray-700 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600">
        <img src="{{ url_for('static',filename='images/profileicons/'+user.image) }}" alt="Profile"
          class="w-10 h-10 rounded-full object-cover" />
        <div class="text-left hidden sm:block">
          <span class="block font-semibold text-gray-900 dark:text-white">{{ user }}</span>
          <span class="text-sm text-gray-500 dark:text-gray-400">ADMIN</span>
        </div>
      </button>
      <div id="dropdown-admin"
        class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg z-50">
        <a href="{{ url_for('main.profilesettings') }}"
          class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-600">Profile
          Settings</a>
        <a href="{{ url_for('admin.adminlogout') }}"
          class="block px-4 py-2 text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Logout</a>
      </div>
    </div>
  </div>
</nav>
<!-- Reservation Details Modal -->
<div id="reservationDetailsModal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Reservation Details</h3>
      <button onclick="closeReservationModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ID Number</label>
        <p id="modal-idno" class="mt-1 text-sm text-gray-900 dark:text-white"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Request Date</label>
        <p id="modal-request-date" class="mt-1 text-sm text-gray-900 dark:text-white"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Reservation Date</label>
        <p id="modal-reserve-date" class="mt-1 text-sm text-gray-900 dark:text-white"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Laboratory</label>
        <p id="modal-lab" class="mt-1 text-sm text-gray-900 dark:text-white"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Computer Number</label>
        <p id="modal-computer" class="mt-1 text-sm text-gray-900 dark:text-white"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Purpose</label>
        <p id="modal-purpose" class="mt-1 text-sm text-gray-900 dark:text-white"></p>
      </div>
    </div>

    <div class="flex justify-end space-x-3 mt-6">
      <button id="modal-decline-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
        Decline
      </button>
      <button id="modal-approve-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
        Approve
      </button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Admin Script
  document
    .getElementById("profile-menu-admin")
    ?.addEventListener("click", function () {
      document.getElementById("dropdown-admin").classList.toggle("hidden");
    });

  const notificationButton = document.getElementById('notification-button-admin');
  const notificationDropdown = document.getElementById('notification-dropdown-admin');


  // Toggle dropdown
  notificationButton.addEventListener('click', () => {
    notificationDropdown.classList.toggle('hidden');
  });
  // Notification handling
  let notifications = [];
  let unreadCount = 0;

  // Function to show notification badge
  function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    if (unreadCount > 0) {
      badge.classList.remove('hidden');
      badge.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
    } else {
      badge.classList.add('hidden');
    }
  }

  // Function to format date
  function formatDate(dateString) {
    if (!dateString) return '';
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateString).toLocaleDateString(undefined, options);
  }

  // Function to render notifications
  function renderNotifications() {
    const itemsContainer = document.getElementById('notification-items');
    const emptyState = document.getElementById('empty-notifications');

    itemsContainer.innerHTML = '';

    if (notifications.length === 0) {
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');

    notifications.forEach((reservation, index) => {
      const notificationItem = document.createElement('div');
      notificationItem.className = `px-4 py-3 border-b border-gray-100 dark:border-gray-600 ${reservation.unread ? 'bg-blue-50 dark:bg-gray-800' : ''}`;
      notificationItem.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-white">${reservation.fullname}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${reservation.lab_name} â€¢ PC-${reservation.computer}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${formatDate(reservation.reserve_date)}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="handleApproval(${reservation.reservation_id}, ${index}); event.stopPropagation();" 
                            class="text-xs px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded hover:bg-green-200 dark:hover:bg-green-800 transition">
                        Approve
                    </button>
                    <button onclick="handleDecline(${reservation.reservation_id}, ${index}); event.stopPropagation();" 
                            class="text-xs px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded hover:bg-red-200 dark:hover:bg-red-800 transition">
                        Decline
                    </button>
                </div>
            </div>
            <div class="mt-2 text-sm text-gray-700 dark:text-gray-300">
                <span class="font-medium">Purpose:</span> ${reservation.purpose}
            </div>
        `;

      notificationItem.addEventListener('click', () => {
        markAsRead(index);
      });

      itemsContainer.appendChild(notificationItem);
    });
  }

  async function handleApproval(reservationId) {
    const result = await Swal.fire({
      title: 'Confirm Approval',
      text: "Are you sure you want to approve this reservation?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, approve it!'
    });

    if (result.isConfirmed) {
      try {
        // Updated to match your route with reservation_id in URL
        const response = await fetch(`/admin/api/approve_reservation/${reservationId}`, {
          method: 'GET',  // Changed to GET to match your route
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          await Swal.fire(
            'Approved!',
            data.message || 'The reservation has been approved.',
            'success'
          );
          // Refresh just the table content
          await loadReservations();
        } else {
          throw new Error(data.message || 'Approval failed');
        }
      } catch (error) {
        Swal.fire(
          'Error!',
          error.message || 'There was an error approving the reservation.',
          'error'
        );
      }
    }
  }

  async function handleDecline(reservationId) {
    const result = await Swal.fire({
      title: 'Confirm Decline',
      text: "Are you sure you want to decline this reservation?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, decline it!'
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch(`/admin/api/decline_reservation/${reservationId}`);

        // Handle non-OK responses
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Server responded with status ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          await Swal.fire({
            title: 'Declined!',
            text: data.message || 'The reservation has been declined.',
            icon: 'success'
          });
          await loadReservations();
        } else {
          throw new Error(data.message || 'Decline operation failed');
        }
      } catch (error) {
        console.error('Decline error:', error);
        await Swal.fire({
          title: 'Error!',
          text: error.message || 'There was an error declining the reservation.',
          icon: 'error'
        });
      }
    }
  }

  // Function to mark notification as read
  function markAsRead(index) {
    if (notifications[index].unread) {
      notifications[index].unread = false;
      unreadCount--;
      updateNotificationBadge();
      renderNotifications();
    }
  }

  // Load reservations and check for new ones
  async function loadReservations() {
    try {
      const response = await fetch("{{ url_for('admin.get_pending_reservations') }}");
      const pendingReservations = await response.json();

      // Clear existing notifications and repopulate
      notifications = pendingReservations.map(res => ({ ...res, unread: true }));
      unreadCount = notifications.length;
      updateNotificationBadge();
      renderNotifications();

    } catch (error) {
      console.error("Error loading reservations:", error);
    }
  }

  // Initial load when page loads
  document.addEventListener("DOMContentLoaded", () => {
    loadReservations();
    // Check for new reservations every 30 seconds
    setInterval(loadReservations, 30000);
  });
</script>
{% elif user_in_login_page and action=='Logout' and user.role == 'Student'%}
<nav class="flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-800 text-white shadow-sm"
  data-user-id="{{ user.idno }}">
  <div
    class="text-3xl font-bold text-transparent bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text">
    <a href="{{ url_for('main.dashboard') }}">CCSit.</a>
  </div>
  <div class="relative flex items-center space-x-8 pr-12">

    <!-- Notification Button (existing) -->
    <div class="relative">
      <button id="notification-button"
        class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white relative"
        aria-label="Notifications">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <span id="notification-badge"
          class="hidden absolute top-0 right-0 inline-block w-3 h-3 bg-red-500 border-2 border-white dark:border-gray-800 rounded-full"></span>
      </button>

      <!-- Notification Dropdown -->
      <div id="notification-dropdown"
        class="hidden absolute right-0 mt-2 w-72 bg-white dark:bg-gray-700 rounded-lg shadow-lg z-50 divide-y divide-gray-100 dark:divide-gray-600">
        <div class="px-4 py-3 text-sm text-gray-900 dark:text-white">
          <p class="font-medium">Notifications</p>
        </div>
        <div class="py-1 max-h-96 overflow-y-auto">
          <!-- Empty State -->
          <div id="empty-notifications-student" class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400">
            No new notifications
          </div>
          <!-- Notification Items (dynamically populated) -->
          <div id="notification-items-student"></div>
        </div>
        <div class="py-1">
          <a href="#"
            class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 text-center">
            View all notifications
          </a>
        </div>
      </div>
    </div>

    <!-- Ranking Badge - Updated with fire animations -->
    <div
      class="hidden sm:flex items-center space-x-2 bg-white dark:bg-gray-700 px-3 py-1 rounded-full shadow-sm relative">
      <!-- Fire animation container -->
      <div id="rank-fire-animation" class="absolute -inset-1 rounded-full pointer-events-none overflow-hidden hidden">
        <!-- Fire particles will be added here by JavaScript -->
      </div>

      <div class="relative z-10">
        <div id="rank-badge"
          class="w-8 h-8 flex items-center justify-center rounded-full text-white font-bold relative">
          <p id="rankingP">N/A</p>
        </div>
        <div
          class="absolute -bottom-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center z-20">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z"
              clip-rule="evenodd" />
          </svg>
        </div>
      </div>
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Rank</span>
    </div>

    <!-- Profile Menu (existing) -->
    <div class="relative">
      <button id="profile-menu-user"
        class="flex items-center space-x-3 p-2 bg-white dark:bg-gray-700 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600">
        <img src="{{ url_for('static',filename='images/profileicons/'+user.image) }}" alt="Profile"
          class="w-10 h-10 rounded-full object-cover" />
        <div class="text-left hidden sm:block">
          <span class="block font-semibold text-gray-900 dark:text-white">{{ user }}</span>
          <span class="text-sm text-gray-500 dark:text-gray-400">STUDENT</span>
        </div>
      </button>
      <div id="dropdown-user"
        class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg z-50">
        <a href="{{ url_for('main.profilesettings') }}"
          class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-600">Profile
          Settings</a>
        <a href="{{ url_for('main.logout') }}"
          class="block px-4 py-2 text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Logout</a>
      </div>
    </div>
  </div>
</nav>
<script>
  // Student Script
  document
    .getElementById("profile-menu-user")
    ?.addEventListener("click", function () {
      document.getElementById("dropdown-user").classList.toggle("hidden");
    });

  document.addEventListener('DOMContentLoaded', () => {
    const notificationButton = document.getElementById('notification-button');
    const notificationDropdown = document.getElementById('notification-dropdown');
    const notificationItems = document.getElementById('notification-items-student');
    const emptyState = document.getElementById('empty-notifications-student');

    // Toggle dropdown
    notificationButton.addEventListener('click', () => {
      notificationDropdown.classList.toggle('hidden');
    });

    // Fetch reservation on page load
    fetch('/api/notify-reservation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(res => res.json())
      .then(result => {
        if (!result.success) {
          console.error("Error:", result.error);
          return;
        }

        const data = result.data;
        const reserveDate = new Date(data.reserve_date);
        const today = new Date();

        if (reserveDate.toDateString() === today.toDateString()) {
          emptyState.classList.add('hidden'); // hide 'No notifications'

          // === 1. Standard "reservation today" notification ===
          const notifElement = document.createElement('div');
          notifElement.className = "px-4 py-2 text-sm text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600";
          notifElement.textContent = `ðŸ”” You have a reservation today in Lab ${data.lab_name}`;

          notifElement.addEventListener('click', () => {
            Swal.fire({
              title: 'Your Reservation Today',
              html: `
        <b>Lab:</b> ${data.lab_name}<br>
        <b>Computer:</b> ${data.computer}<br>
        <b>Purpose:</b> ${data.purpose}<br>
        <b>Status:</b> ${data.lab_status}<br>
        <b>Time:</b> ${new Date(data.reserve_date).toLocaleString()}
      `,
              icon: 'info',
              confirmButtonColor: '#3085d6',
              confirmButtonText: 'Okay!'
            });
          });

          notificationItems.appendChild(notifElement);
          document.getElementById('notification-badge').classList.remove('hidden');

          // === 2. Check if reservation is 15 minutes from now ===
          const now = new Date();
          const diffMs = reserveDate - now;
          const diffMin = Math.floor(diffMs / 60000); // convert ms to minutes

          if (diffMin === 15) {
            console.log('15 MINUTES NALANG!')
            Swal.fire({
              title: 'Reservation Reminder',
              text: `ðŸ•’ Your reservation at Lab ${data.lab_name} is in 15 minutes. Please confirm your attendance.`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Yes, Iâ€™m coming',
              cancelButtonText: 'Cancel',
              confirmButtonColor: '#28a745',
              cancelButtonColor: '#d33'
            }).then((result) => {
              if (result.isConfirmed) {
                // Call API to confirm reservation
                fetch(`/api/confirm-reservation/${data.reservation_id}`)
                  .then(res => res.json())
                  .then(response => {
                    if (response.success) {
                      Swal.fire('Confirmed!', 'Your reservation is confirmed.', 'success');
                    } else {
                      Swal.fire('Error', response.error, 'error');
                    }
                  });
              } else if (result.dismiss === Swal.DismissReason.cancel) {
                // Call API to expire reservation
                fetch(`/api/expire-reservation/${data.reservation_id}`)
                  .then(res => res.json())
                  .then(response => {
                    if (response.success) {
                      Swal.fire('Cancelled', 'Your reservation has been marked as expired.', 'info');
                    } else {
                      Swal.fire('Error', response.error, 'error');
                    }
                  });
              }
            });
          }

        }

      })
      .catch(error => {
        console.error("Fetch error:", error);
      });
  });

  // Function to create fire animation
  function createFireAnimation(rank) {
    const colors = {
      1: { base: 'from-yellow-400 to-red-500', fire: 'from-red-500 to-yellow-300' },
      2: { base: 'from-gray-300 to-gray-500', fire: 'from-gray-400 to-white' },
      3: { base: 'from-amber-500 to-amber-700', fire: 'from-amber-600 to-yellow-200' }
    };

    const badge = document.getElementById('rank-badge');
    const fireContainer = document.getElementById('rank-fire-animation');

    // Clear previous animation
    fireContainer.innerHTML = '';
    fireContainer.className = 'absolute -inset-1 rounded-full pointer-events-none overflow-hidden hidden';

    // Set base color for badge
    badge.className = `w-8 h-8 flex items-center justify-center rounded-full text-white font-bold relative bg-gradient-to-br ${colors[rank].base}`;

    // Only show fire for top 3
    if (rank <= 3) {
      fireContainer.classList.remove('hidden');

      // Create fire particles
      for (let i = 0; i < 12; i++) {
        const particle = document.createElement('div');
        particle.className = `absolute rounded-full bg-gradient-to-b ${colors[rank].fire} opacity-80`;

        // Random positioning and sizing
        const size = Math.random() * 8 + 4;
        const posX = Math.random() * 30 - 15;
        const posY = Math.random() * 30 - 15;

        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `calc(50% + ${posX}px)`;
        particle.style.top = `calc(50% + ${posY}px)`;
        particle.style.transform = 'translate(-50%, -50%)';

        // Animation
        particle.style.animation = `fire-flicker ${Math.random() * 0.5 + 0.5}s infinite alternate`;

        fireContainer.appendChild(particle);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', async function () {
    try {
      const rankElement = document.getElementById('rankingP');
      const response = await fetch(`/api/myRank/${"{{ user.idno }}"}`);


      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const data = await response.json();

      if (data.success && data.data) {
        const rank = data.data.rank;
        rankElement.textContent = rank;

        // Add special effects for top 3 ranks
        if (rank <= 3) {
          createFireAnimation(rank);

          // Add crown for 1st place
          if (rank === 1) {
            const crown = document.createElement('div');
            crown.innerHTML = `
              <svg class="absolute -top-5 -left-2 w-10 h-10 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0V6H8a1 1 0 010-2h1V3a1 1 0 011-1zm-3 6a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H8a1 1 0 01-1-1V8z" clip-rule="evenodd" />
                <path d="M4 10a1 1 0 011-1h1v1a1 1 0 01-1 1H5a1 1 0 01-1-1v-1zm10-1a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1V9a1 1 0 011-1z" />
              </svg>
            `;
            document.getElementById('rank-badge').appendChild(crown);
          }
        } else {
          // Default styling for ranks > 3
          document.getElementById('rank-badge').className =
            'w-8 h-8 flex items-center justify-center bg-blue-400 rounded-full text-white font-bold relative';
        }
      } else {
        throw new Error(data.error || 'Invalid response format');
      }
    } catch (error) {
      console.error('Fetch error:', error);
      document.getElementById('rankingP').textContent = 'N/A';
    }

  });


</script>
<style>
  @keyframes fire-flicker {
    0% {
      opacity: 0.8;
      transform: translate(-50%, -50%) scale(1);
    }

    50% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }

    100% {
      opacity: 0.6;
      transform: translate(-50%, -50%) scale(0.9);
    }
  }

  #rank-fire-animation div {
    filter: blur(1px);
    will-change: transform, opacity;
  }

  /* Special glow for 1st place */
  .rank-1-glow {
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    animation: gold-pulse 2s infinite alternate;
  }

  @keyframes gold-pulse {
    0% {
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    100% {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.9);
    }
  }
</style>
{% elif user_in_login_page and action=='Logout' and user.role == 'Staff'%}
<nav class="flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-800 text-white shadow-sm">
  <div
    class="text-3xl font-bold text-transparent bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text">
    <a href="{{ url_for('staff.dashboard') }}">CCSit.</a>
  </div>
  <div class="relative flex items-center space-x-8 pr-12">
    <div class="relative">
      <button id="profile-menu-user"
        class="flex items-center space-x-3 p-2 bg-white dark:bg-gray-700 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600">
        <img src="{{  url_for('static',filename='images/profileicons/'+user.image) }}" alt="Profile"
          class="w-10 h-10 rounded-full object-cover" />
        <div class="text-left hidden sm:block">
          <span class="block font-semibold text-gray-900 dark:text-white">{{ user }}</span>
          <span class="text-sm text-gray-500 dark:text-gray-400">STAFF</span>
        </div>
      </button>
      <div id="dropdown-user"
        class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg z-50">
        <a href="{{ url_for('main.profilesettings') }}"
          class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-600">Profile
          Settings</a>
        <a href="{{ url_for('staff.logout') }}"
          class="block px-4 py-2 text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Logout</a>
      </div>
    </div>
  </div>
</nav>
{% else %}
<nav class="flex justify-between items-center p-4 bg-black text-white shadow-sm">
  <div
    class="text-3xl font-bold text-transparent bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text">
    <a href="{{ url_for('main.index') }}">CCSit.</a>
  </div>
  <div class="flex space-x-8 text-l text-white pr-12">
    <a href="{{ url_for('main.index') }}" class="text-white text-l hover:text-blue-600">{{ action }}</a>
  </div>
</nav>
{% endif %}


{% endmacro %}
{% macro user_card(student) -%}
<!-- User Info Card -->
<div
  class="mx-auto max-w-sm bg-white rounded-xl shadow-lg p-6 space-y-4 dark:bg-slate-800 dark:shadow-none dark:outline dark:outline-1 dark:outline-white/10">
  <div class="text-center">
    <h2 class="text-2xl font-semibold text-black dark:text-white">
      User Information
    </h2>
    <p class="text-gray-500 dark:text-gray-400">
      Details for {{ student.lastname }}
    </p>
  </div>
  <!-- Role -->
  <div class="flex items-center justify-between">
    <span class="text-gray-600 dark:text-gray-300">Role:</span>
    <span class="font-medium text-black dark:text-white">{{ student.role }}</span>
  </div>
  <div class="space-y-2">
    <!-- ID Number -->
    <div class="flex items-center justify-between">
      <span class="text-gray-600 dark:text-gray-300">ID Number:</span>
      <span class="font-medium text-black dark:text-white">{{ student.idno }}</span>
    </div>

    <!-- Full Name -->
    <div class="flex items-center justify-between">
      <span class="text-gray-600 dark:text-gray-300">Full Name:</span>
      <span class="font-medium text-black dark:text-white">{{ student }}</span>
    </div>

    <!-- Course -->
    <div class="flex items-center justify-between">
      <span class="text-gray-600 dark:text-gray-300">Course:</span>
      <span class="font-medium text-black dark:text-white">{{ student.course }}</span>
    </div>

    <!-- Year -->
    <div class="flex items-center justify-between">
      <span class="text-gray-600 dark:text-gray-300">Year:</span>
      <span class="font-medium text-black dark:text-white">{{ student.year }}</span>
    </div>
    <!-- Email -->
    <div class="flex items-center justify-between">
      <span class="text-gray-600 dark:text-gray-300">Email:</span>
      <span class="font-medium text-black dark:text-white">{{ student.email }}</span>
    </div>
  </div>
</div>
{%- endmacro %} {% macro logincard_for_admin_staff(user) -%}
<div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
  <div class="flex justify-center mb-6">
    <button id="login-tab"
      class="px-6 py-2 text-lg font-semibold text-gray-700 border-b-2 border-blue-500 focus:outline-none">
      {{ user.title() }} Login
    </button>
  </div>

  <!-- Login Form -->
  <form id="login-form"
    action="{% if user == 'admin' %}{{ url_for('admin.loginadmin') }}{% else %}{{ url_for('staff.loginstaff') }}{% endif %}"
    method="post" class="space-y-4">
    <div>
      <label for="login-email" class="block text-sm font-medium text-gray-700">IDNO</label>
      <input type="text" name="idno" placeholder="Enter your ID Number"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
        required />
    </div>
    <div>
      <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
      <input type="password" name="password" placeholder="Enter your password"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
        required />
    </div>
    <button type="submit"
      class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
      Login
    </button>
  </form>
</div>
{%- endmacro %} {%- macro logincard(user)%}
<div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
  <div class="flex justify-center mb-6">
    <button id="login-tab"
      class="px-6 py-2 text-lg font-semibold text-gray-700 border-b-2 border-blue-500 focus:outline-none">
      {{ user }} Login
    </button>
  </div>

  <!-- Login Form -->
  <form id="login-form" action="{{ url_for('admin.loginadmin') }}" method="post" class="space-y-4">
    <div>
      <label for="login-email" class="block text-sm font-medium text-gray-700">IDNO</label>
      <input type="text" name="idno" placeholder="Enter your ID Number"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
        required />
    </div>
    <div>
      <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
      <input type="password" name="password" placeholder="Enter your password"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
        required />
    </div>
    <button type="submit"
      class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
      Login
    </button>
  </form>
</div>
{%- endmacro %} {% macro sitin_modal() %}
<!-- Sit-in Modal -->
<div id="sitInModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg w-11/12 md:w-1/3 p-6">
    <!-- Close Icon -->
    <div class="flex justify-end">
      <button onclick="closeSitInModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <!-- Modal Content -->
    <h2 class="text-xl font-semibold mb-4">Sit-in Details</h2>
    <form id="sitInModalForm" class="space-y-4">
      <!-- ID Number -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">ID Number</label>
        <input type="text" name="idno" id="modal-idno-sitin"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly />
      </div>
      <!-- Student Full Name -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Student Full Name</label>
        <input type="text" id="modal-fullname"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly />
      </div>
      <!-- Purpose Dropdown -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Purpose</label>
        <select name="reason" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
          <option value="#" selected>Select Purpose</option>
          <option value="Python">Python</option>
          <option value="C#">C#</option>
          <option value="Java">Java</option>
          <option value="WEB DEV">WEB DEV</option>
          <option value="Database">Database</option>
          <option value="Digital Logic & Design">Digital Logic & Design</option>
          <option value="Embedded System & IoT">Embedded System & IoT</option>
          <option value="System Integration & Architecture">System Integration & Architecture</option>
          <option value="Computer Application">Computer Application</option>
          <option value="Project Management">Project Management</option>
          <option value="IT Trends">IT Trends</option>
          <option value="Technopreneurship">Technopreneurship</option>
          <option value="Capstone">Capstone</option>
        </select>
      </div>
      <!-- Lab Dropdown -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Lab</label>
        <select id="lab" name="lab_id"
          class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          required>
          <option value="#" selected> Choose a Lab</option>
          <!-- Dynamic options will be inserted here -->
        </select>
        <!-- Remaining Session -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Remaining Session</label>
          <input type="text" id="modal-session"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly />
        </div>
        <!-- Buttons -->
        <div class="flex justify-center space-x-4 mt-6">
          <button type="submit" class="bg-green-500 text-white px-4 w-64 py-2 rounded-md hover:bg-green-600">
            Sit-in
          </button>
        </div>
    </form>
  </div>
</div>
<script>
  // Fetch labs from the server and populate the "lab" select dropdown
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/admin/api/get-laboratories')
      .then(response => response.json())
      .then(labs => {
        const labSelect = document.getElementById('lab');

        // Check if labs were successfully fetched
        if (Array.isArray(labs) && labs.length > 0) {
          labs.forEach(lab => {
            const option = document.createElement('option');
            option.value = lab.lab_id; // Use lab_id as the value
            option.textContent = `Lab ${lab.lab_name}`; // Display lab name
            labSelect.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error fetching labs:', error));

    // Event listener for when a lab is selected
    document.getElementById('lab').addEventListener('change', function () {
      const selectedLabId = this.value;
      const scheduleSelect = document.getElementById('schedule');

      // Clear previous schedules
      scheduleSelect.innerHTML = '<option value="">Select a time</option>';

      // Fetch the lab schedules for the selected lab
      fetch(`/api/labs/${selectedLabId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.vacant_time) {
            data.vacant_time.forEach(time => {
              const option = document.createElement('option');
              option.value = time;
              option.textContent = time;
              scheduleSelect.appendChild(option);
            });
          }
        })
        .catch(error => console.error('Error fetching lab schedules:', error));
    });
  });
</script>
{% endmacro %}