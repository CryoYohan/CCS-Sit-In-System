{% extends 'admindashboardtemplate.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-r from-blue-50 to-purple-50 p-8 animate-fadeIn z-10">
  <!-- Header -->
  <div class="flex justify-between items-center mb-8 p-6 bg-white rounded-xl shadow-md animate-slideDown">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
      üìã Sit-In Records
      <span class="ml-2 text-2xl">üìä</span>
    </h1>
    <div class="flex space-x-4">
      <span class="text-2xl">üåü</span>
      <span class="text-2xl">üîç</span>
    </div>
  </div>

  <!-- Export and Filter Buttons -->
  <div class="mb-8 bg-white p-6 rounded-xl shadow-md animate-slideUp">
    <div class="flex flex-wrap justify-between gap-4">
      <!-- Export Buttons -->
      <div class="flex gap-3">
        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Generate PDF
        </button>
        <button
          class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Generate Excel
        </button>
        <button
          class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Generate Word
        </button>
      </div>

      <!-- Filter Dropdowns -->
      <div class="flex gap-3">
        <!-- Lab Filter Dropdown -->
        <div class="flex items-center gap-2">
          <label class="block text-sm font-medium text-gray-600 whitespace-nowrap">Filter by Lab</label>
          <select id="lab-filter"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition border-none focus:ring-2 focus:ring-blue-500">
            <option value="all">All Labs</option>
            <option value="530">Lab 530</option>
            <option value="544">Lab 544</option>
            <option value="528">Lab 528</option>
            <option value="526">Lab 526</option>
          </select>
        </div>

        <!-- Purpose Filter Dropdown -->
        <div class="flex items-center gap-2">
          <label class="block text-sm font-medium text-gray-600 whitespace-nowrap">Filter by Purpose</label>
          <select
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition border-none focus:ring-2 focus:ring-blue-500">
            <option value="all">All Purposes</option>
            <option value="class">ASP NET CORE</option>
            <option value="research">Python</option>
            <option value="thesis">Java</option>
            <option value="personal">C#</option>
            <option value="personal">Web Dev</option>
          </select>
        </div>
      </div>
    </div>
  </div>


  <!-- Scrollable Sit-In Records Table with Fixed Height -->
  <div class="bg-white rounded-2xl shadow-xl overflow-hidden animate-slideUp">
    <div class="overflow-auto" style="max-height: 500px;">
      <table class="w-full table-auto">
        <thead class="bg-gray-100 sticky top-0 z-10">
          <tr>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Record ID</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Student ID</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Lab</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Check-in</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Check-out</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Staff ID</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Logged Off By</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Status</th>
            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 whitespace-nowrap">Reason</th>
          </tr>
        </thead>

        <tbody id="sitinRecordTbody" class="divide-y divide-gray-200">
          <!-- Table rows will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Helper functions
    function formatDate(datetime) {
      if (!datetime) return 'N/A';
      return new Date(datetime).toLocaleString();
    }

    function getStatusColor(status) {
      const statusColors = {
        "Pending": "bg-yellow-100 text-yellow-800",
        "Approved": "bg-green-100 text-green-400",
        "In-lab": "bg-blue-100 text-blue-800",
        "Completed": "bg-gray-100 text-gray-800",
        "Denied": "bg-red-100 text-red-800"
      };
      return statusColors[status] || "bg-gray-100 text-gray-800";
    }

    // Main table update function
    function updateTable(records) {
      const tbody = document.getElementById('sitinRecordTbody');
      tbody.innerHTML = ''; // Clear existing rows

      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-4 text-gray-500">
              No records found
            </td>
          </tr>
        `;
        return;
      }

      records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition';
        row.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-700">${record.record_id}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${record.idno}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${record.lab_name}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${formatDate(record.sitin_in)}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${formatDate(record.sitin_out) || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${record.staff_idno || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${record.logged_off_by || 'N/A'}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs font-semibold ${getStatusColor(record.status)} rounded-full">
              ${record.status}
            </span>
          </td>
          <td class="px-4 py-3 text-sm text-gray-700">${record.reason || 'N/A'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Data fetching functions
    async function fetchRecordsByLab(labName) {
      try {
        const endpoint = labName ? `/admin/api/records-by-lab/${labName}` : '/admin/api/sitinrecords';
        const response = await fetch(endpoint);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const records = await response.json();
        updateTable(records);
      } catch (error) {
        console.error("Error fetching records:", error);
        const tbody = document.getElementById('sitinRecordTbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-4 text-red-500">
              Error loading records: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Event handlers
    function handleLabFilterChange(event) {
      const labName = event.target.value;
      fetchRecordsByLab(labName === 'all' ? '' : labName);
    }

    // Modal functions
    function togglePassword(id) {
      const field = document.getElementById(id);
      field.type = field.type === "password" ? "text" : "password";
    }

    function openEditModal() {
      document.getElementById("editModal").classList.remove("hidden");
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.add("hidden");
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      // Set up event listeners
      const labFilter = document.getElementById('lab-filter');
      if (labFilter) {
        labFilter.addEventListener('change', handleLabFilterChange);
      }

      // Initial data load
      fetchRecordsByLab('');
    });
  </script>

  <!-- Animations -->
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.8s ease-out forwards;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slideDown {
      animation: slideDown 0.8s ease-out forwards;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slideUp {
      animation: slideUp 0.8s ease-out forwards;
    }
  </style>
  {% endblock %}